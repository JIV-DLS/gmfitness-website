// ðŸ” RÃ¨gles de sÃ©curitÃ© Firestore pour GM Fitness
// Ces rÃ¨gles protÃ¨gent vos donnÃ©es cÃ´tÃ© serveur

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ‘¤ Collection des utilisateurs
    match /users/{userId} {
      // Les utilisateurs peuvent lire et Ã©crire leurs propres donnÃ©es
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Les admins peuvent lire tous les profils
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ðŸ’¬ Collection des tÃ©moignages
    match /testimonials/{testimonialId} {
      // Lecture: tout le monde peut lire les tÃ©moignages publics
      allow read: if resource.data.isPublic == true;
      
      // Ã‰criture: utilisateurs authentifiÃ©s seulement
      allow create: if request.auth != null &&
                       validateTestimonialData(request.resource.data) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Mise Ã  jour: seulement le crÃ©ateur ou un admin
      allow update: if request.auth != null && (
                       resource.data.createdBy == request.auth.uid ||
                       isAdmin(request.auth.uid)
                    ) && validateTestimonialData(request.resource.data);
      
      // Suppression: seulement le crÃ©ateur ou un admin
      allow delete: if request.auth != null && (
                       resource.data.createdBy == request.auth.uid ||
                       isAdmin(request.auth.uid)
                    );
    }
    
    // ðŸŽ¥ Collection des vidÃ©os de coaching
    match /coaching_videos/{videoId} {
      // Lecture: selon la visibilitÃ©
      allow read: if resource.data.isPublic == true ||
                     (request.auth != null && resource.data.createdBy == request.auth.uid) ||
                     (request.auth != null && isAdmin(request.auth.uid));
      
      // Ã‰criture: admins et coaches seulement
      allow create, update: if request.auth != null && 
                               (isAdmin(request.auth.uid) || isCoach(request.auth.uid)) &&
                               validateVideoData(request.resource.data);
      
      // Suppression: crÃ©ateur ou admin
      allow delete: if request.auth != null && (
                       resource.data.createdBy == request.auth.uid ||
                       isAdmin(request.auth.uid)
                    );
    }
    
    // ðŸ“Š Collection des statistiques (lecture seule pour les admins)
    match /stats/{statId} {
      allow read: if request.auth != null && isAdmin(request.auth.uid);
      allow write: if false; // Les stats sont gÃ©nÃ©rÃ©es par Cloud Functions
    }
    
    // ðŸ“… Collection des rÃ©servations
    match /bookings/{bookingId} {
      // Les utilisateurs peuvent voir leurs propres rÃ©servations
      allow read: if request.auth != null && (
                     resource.data.clientId == request.auth.uid ||
                     isAdmin(request.auth.uid) ||
                     isCoach(request.auth.uid)
                  );
      
      // CrÃ©ation: utilisateurs authentifiÃ©s
      allow create: if request.auth != null &&
                       request.resource.data.clientId == request.auth.uid &&
                       validateBookingData(request.resource.data);
      
      // Mise Ã  jour: client propriÃ©taire, coach ou admin
      allow update: if request.auth != null && (
                       resource.data.clientId == request.auth.uid ||
                       isAdmin(request.auth.uid) ||
                       isCoach(request.auth.uid)
                    );
      
      // Suppression: admins seulement
      allow delete: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // ðŸ”§ Fonctions utilitaires pour la validation
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) &&
             get(/databases/$(database)/documents/users/$(uid)).data.role == 'admin';
    }
    
    function isCoach(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) &&
             get(/databases/$(database)/documents/users/$(uid)).data.role in ['admin', 'coach'];
    }
    
    function validateTestimonialData(data) {
      return data.keys().hasAll(['clientName', 'rating', 'content', 'serviceType', 'isPublic']) &&
             data.rating is number &&
             data.rating >= 1 && data.rating <= 5 &&
             data.content is string &&
             data.content.size() >= 10 && data.content.size() <= 1000 &&
             data.clientName is string &&
             data.clientName.size() >= 2 && data.clientName.size() <= 100 &&
             data.isPublic is bool;
    }
    
    function validateVideoData(data) {
      return data.keys().hasAll(['title', 'category', 'isPublic']) &&
             data.title is string &&
             data.title.size() >= 5 && data.title.size() <= 200 &&
             data.category in ['workout', 'nutrition', 'motivation', 'technique', 'testimonial', 'behind_scenes', 'q_and_a'] &&
             data.isPublic is bool;
    }
    
    function validateBookingData(data) {
      return data.keys().hasAll(['serviceType', 'preferredDate', 'status']) &&
             data.serviceType is string &&
             data.preferredDate is timestamp &&
             data.status in ['pending', 'confirmed', 'cancelled', 'completed'];
    }
  }
}

// ðŸ—„ï¸ RÃ¨gles pour Firebase Storage
service firebase.storage {
  match /b/{bucket}/o {
    
    // ðŸŽ¥ Dossier des vidÃ©os
    match /videos/{allPaths=**} {
      // Lecture: tout le monde (pour les vidÃ©os publiques)
      allow read: if true;
      
      // Ã‰criture: utilisateurs authentifiÃ©s seulement
      allow write: if request.auth != null &&
                      validateFileUpload() &&
                      request.resource.size < 100 * 1024 * 1024; // 100MB max
    }
    
    // ðŸ“¸ Dossier des images
    match /images/{allPaths=**} {
      // Lecture: tout le monde
      allow read: if true;
      
      // Ã‰criture: utilisateurs authentifiÃ©s
      allow write: if request.auth != null &&
                      validateImageUpload() &&
                      request.resource.size < 10 * 1024 * 1024; // 10MB max
    }
    
    // ðŸ‘¤ Dossier des avatars utilisateurs
    match /avatars/{userId}/{allPaths=**} {
      // Lecture: tout le monde
      allow read: if true;
      
      // Ã‰criture: propriÃ©taire seulement
      allow write: if request.auth != null &&
                      request.auth.uid == userId &&
                      validateImageUpload() &&
                      request.resource.size < 5 * 1024 * 1024; // 5MB max
    }
    
    function validateFileUpload() {
      return request.resource.contentType.matches('video/.*') ||
             request.resource.contentType.matches('image/.*');
    }
    
    function validateImageUpload() {
      return request.resource.contentType in ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
    }
  }
}